name: Build Custom Kernel for Xiaomi 13

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      build_target:
        description: ‘Build target description'
        required: false
        default: ‘Xiaomi 13 (HyperOS)'

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout source code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Set up build environment
      run: |
        sudo apt-get update
        sudo apt-get install -y git build-essential flex bison libssl-dev libelf-dev bc python3 kmod

    - name: Download Clang Toolchain
      run: |
        mkdir -p $HOME/toolchains
        cd $HOME/toolchains
        # 使用一个广泛验证的 Clang 版本
        wget -q https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/main/clang-r510928.tar.gz
        mkdir clang && tar -xzf clang-r510928.tar.gz -C clang

    - name: Configure Kernel
      env:
        PATH: ${{ github.workspace }}/../toolchains/clang/bin:$PATH
      run: |
        cd ${{ github.workspace }}
        # 1. 首先检查可用的配置文件，确认名称
        find arch/arm64/configs -name “*defconfig” | head -10
        # 2. 使用正确的 defconfig 进行配置（这里以 gki_defconfig 为例，请根据上一条命令的输出确认）
        make ARCH=arm64 CC=clang CLANG_TRIPLE=aarch64-linux-gnu- CROSS_COMPILE=aarch64-linux-android- gki_defconfig O=out
        # 3. (可选) 强制开启 USB 3.0 相关配置
        ./scripts/config --file out/.config --set-str CONFIG_USB_XHCI_HCD y

    - name: Build Kernel
      env:
        PATH: ${{ github.workspace }}/../toolchains/clang/bin:$PATH
      run: |
        cd ${{ github.workspace }}
        make ARCH=arm64 CC=clang CLANG_TRIPLE=aarch64-linux-gnu- CROSS_COMPILE=aarch64-linux-android- -j$(nproc) O=out 2>&1 | tee build.log
        # 验证核心产物是否生成
        ls -la out/arch/arm64/boot/

    - name: Package with AnyKernel3
      run: |
        cd ${{ github.workspace }}
        # 清理之前的尝试
        rm -rf AnyKernel3
        # 克隆 AnyKernel3 模板
        git clone --depth=1 https://github.com/osm0sis/AnyKernel3.git
        # 复制内核映像
        cp out/arch/arm64/boot/Image.gz AnyKernel3/
        # 准备修改 AnyKernel3 脚本（此处仅为准备，实际编辑需在本地或通过sed命令）
        cd AnyKernel3
        echo “下一步：请在此目录编辑 anykernel.sh 以添加内核参数”

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: Kernel-Build-Artifacts
        path: |
          ${{ github.workspace }}/out/arch/arm64/boot/Image.gz
          ${{ github.workspace }}/build.log
